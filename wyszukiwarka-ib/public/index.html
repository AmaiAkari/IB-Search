<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wyszukiwarka i Ekstraktor Danych IB Search</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBxIQEhMQExIWExUWExYSFRIXFRAZFxIVFhUWFxkWFRUYHSggGBolGxUVIzEhJSkrLi4uFx8zODMtOSgtLisBCgoKDg0OGxAQGy0lICUtLS0rKy0tLS0rLS0tLS0tLS8tLS0tLS0tLS0tLS0tLS8tLTctKy0tLS0tLS0tLy0tL//AABEIAKIBNwMBIgACEQEDEQH/xAAcAAEAAQUBAQAAAAAAAAAAAAAABQEDBAYHAgj/xAA/EAACAQICBwQIBAMIAwAAAAAAAQIDEQQhBQYSMUFRYSJxgZEHEzJSobHB0RRCcuEjYqIzQ1OCkrLw8SRjc//EABoBAQADAQEBAAAAAAAAAAAAAAACAwQBBQb/xAAuEQACAgEEAQIEBAcAAAAAAAAAAQIRAwQSITFBEzIFUaGxQmHR8BQiJDNxweH/2gAMAwEAAhEDEQA/AO4gAAAAAAAAAAAAAAAAAGJPSdFS2XUV93Rd73I96Qk1SqNb1CTXkzRy/DiU02yuc9pv6d8ypqmhdKuk1CT7D/ofNdDa0yGTG4OmSjLcgCkpJbyKrY+UajzvHl0sVN0WwxufCJYGFLFvhZHh4iXP5EqI7SQBG+ulzYWJlz+R3aKJIEf+Oazdrc9xXDaXpTdk8/H4DYzhng8xknmnc9EQACzUxEVJQveT3RW/vfJBKwXgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUkr5M0jH4V0qkoPhufOL3M3gg9aoR2YS/NtWXWNnf428y/TzqVfMryK1ZrZPaF0q1H1UnmvZb5e79iBBtnBTVMqjLa7NvlJvfmRFas5Nt5cLciMhiJrNSl5v5EnimpRhU3OSV14HnajC4Ruz0tHljKdUZWCrN5ckZLI3A4iMbp8bZmbXrKCuyGJ2iWojtm+ODxjK2xFvjuXeYmAxLvLblla+f0PekZXUbbnd/IwNk1winHkxSbs9Y3Euo+UVuXPqy9o7CNPbeXJfUt4dxi7tXJKlWUldEpyaVIjFW7ZcjNp3TsZdDH3dpeMiPrVLZcWY2IrW7C8WZ1HfKkXSW2O5+eiR0lpW3YpvPjLl3F3QuGtH1ks5S4vfb99/kQWHheST3Xz7uJtlKSaTW4nlShHaiqPLtnsAGcmAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACjklvZ5qzsrmEySVnLM31i5o1HSCrVZuThLfaK2XkuCNgK2Lcb2OyMluNV/CVP8ADl/pZYxrVCO3V/hx96fZXmzB109ICw7lh8LszqK8Z1XnCm+KivzyXkuuaOWYvEVsVU2pynXqyyV9qUn0jFbl0SPW0+nnkW6fC+pnk0uEdCr65YODt6xy/TCbXm0kXlr/AIFxhFznFxTTvSnbN3v2bmn4PUHSFVX9Sqa/9k4R/pzkvFHvE+jjSEVdQpz6Rqxv/VYnl02kyLZKf1RPDlyYpb4o6NobSlDFSSo1Y1M1eKfaS5uLzXkbJjaTaVk95834/R9bCzSq050Zp3i5Jxd1xhLj3pm66oekuth3Gli3KvSyXrd9Wmubf94u/tdXuMsvhPprdhd/v6mjJrnlpTVHT3Qn7r8mU/DS91+TJTC4mFWEatOSnCSUozi7qSfFMumLe0RImOBk96sZVLD7Ksk+rMwEXJsLgiKyne6jLpkywsPP3JeTJ4DG9iJZZeo14pUReDoSV24tcNzM/C1ZQe52e9W+JdAlLd2RXBnxmnuZ6I8zKM7r4FTjR2y4ACJ0AAAAAAAAAAAAAAAAAAAAAAHmpNRV2AegYL0ir+zl35mS66aTWd9x2jtMpinlbqYp7kyiRKPRySpnk0r0k6yvDU1hqUrVaqvKSedOnuuuUpZpPhZ9DfnQSzufPGsWkXisRWxDeUptx6QWUF/pSN+gxLLkt9Ipyy2o86u6BqY6qqNPJLOdRrs0483zfJcfNrsmgdXsPgobNKHaa7VV2c598uXRZHrUrV6ODwsINWqTSqVee21fZ/yrLwb4k44RWd1338BrNY8snFe37ncePar8mIzy4PkZknFcfkeFUTbSzadn0dk/k15mNSLGiPxujYV4OnVhGcHvjJJr9n1OPa/ajSwH8ejeeHbs75yotvJSfGL3KXg+DfcXCXcY+LwEa0JUqnahOLjKL3OLVmjVptVLDK/HlFc4KRxv0W61vC1lhKkv4FaVo33UastzXKMnk+tnzv26x80ayaIlg8TWw0m3sTtGXvQa2oS73FrxufQGoWkfxuBoV5O89lwqdZ024Sfjs3/zGr4lijxmj0/2iGJv2slwZP4Zcx+GXM8nci6jGB7xsfVwlNZ7Kbsa9X0/KKv6vablGEYp5ylOShGKvkryks3kicYuStHG6J4EK9LV6c/VVqMIT2VNbNRzhKN2spOMXdO104r2lZsv09KSbS2Vv6nVjk1aOWiTMrC7n3mNYyMO7J95XLoki+RtbTlGMti7ednJK6X38Cmnsb6unsp9qWS5pcX9PE1Itw4VJWyM51wjf075lS3hobMIx5RS8lYuGZlgAAAAAAAAAAAAAAAAAAMPSTyXeZhj46F4d2YOx7ImRewVTNx8UWZHmnK0k+pZVos8kkysShU5HorydljWfEbGDxU081h6rXfsO3xOE6AwyqYrD03ulXpp922rryO26wYd1MLiKa3yoVEu/YdvicT0JiFSxFCq90a1OTfRTV/hc9b4eqxTrv8A4ZcvuR3XSGA9a4va2WlNbS9pKaSezwTyWe9WXjjUtDwjuUHmuy1Jwyi432W7J2e+27LqSDmjw6h5CNZh0NFRppWVNtOO+Cs9mnGmvLZy32TaL8cJZ7S2VLa2t1l/Z7CW/dfOxWVRniUnzJJEbMi74tWz/YpKouZiM8MmokbOUemahH8XSqL89BJ98Jyz8pLyNp9BNf8A8TEQbyjidpdNqlT3eMX5mo+lrEKWLp01+Sir985SdvJR8za/Qrh3HCV5te3iGl1UacF82/I9bOv6FJ/l9/0KI/3Dp20uY2lzMMHi7TRZXSudGolm9l5I06tgnOOzKErXTulJNOLUoyi1mmmk01uaRuALcc9iohKNuzQNJ4XGQmsVB1cTJRVOpRmo3qU0216pqMYwqRbb5SvZ52anaNKV12XvXBmxAn6vijm0oQOsL7cVw2b28X9ifIDWH+0j+j6s5h94n0RZnaEw/rK0Vwj234bvjYwTP0HVlGtDZV79lr+V7/K1/A1Tva6Ko9m4gA8s1AAAAAAAAAAAAAAAAAAAo1fIqACDrQs2uTLEjNxsfzeDMKRbF2WMksNPain/AMuXSO0f7fg/oSQqiuTtlLHCtZdFvC4mrRt2VJuHWnLOPwdu9M7sarr7q28XSVWmr1qadl/iQ3uHfxXiuJr0WdY50+mU5I2i5qTppYvDRu71KaVOouLsuzP/ADJedyeZw7RGlKuDqqrTdmspRd7SXGMl/wAs0dX0BrPh8Ykoy2KnGjJraX6ffXVeNiWr0rxycorj7EseRSVPsl2eWe2eWY0WMtsxsfi4UKc61R7MIRcpPouXN8LFNKaTo4aHrK1RQXC++XSMVnJ9xyXXHWueOlsRThQi7xhxm/enb4Lh1Nem00sr/L5lM5qJr2mcdLFV6leSe1UndRWbS3RiudkkvA73qhoj8Hg6GHftRhtT/wDpNuU/Jya8Dh+rWkKOGxdGtXpupThLaaX5X+Wez+bZdnbp4P6EwmJhWhGrTkpwmlKM4u6knxTNfxOTSjBLghhXbLoKg8cvKAqACgKgAoa/rD/aR/R9WbCQGsC7cf0fVl2H3kJ9GFgcDOs7RXfJ7l3/AGNq0do2FBZZye+T3vouSMDQtaVOnsuK3trnZ8yYo1VJX+BHNlbdeCUMdKy4ADOTAAAAAAAAAAAAAAAAAAPFWeymyP8Axc1xv4IkKsLpoiZq2R1FkEqK1a91axGV6zg884vjxXRmbIsVYppp7mWwpHJ2+i9ouScrp37L+hKGp0a0qE7ry4SRs2CxcasdqPiuKZPJBrldFClfZeBZlWafQvopsscaNR1s1Khi261JqnWe+/sVf1W9mX8y8TmOlNE18LLZrU5U3fKT9l/pmsn4M74ealNSTjJKSe9NJp96Zuwa6eNU+UUyxJnDMNrNjaStDEztylsz/wB6Z7r64Y+Ss8TJfpjSi/OMUzq2J1QwNTN4aC/RtQ+EGkWqWpGj4u/4ZP8AVOrJeTlY0/xun7cOf8Ih6c/mcUaq4ipbt1qkv1zm/mzZ6Po4xboSrSUYzSvHD3vOS43ayUuSzv0Ou4LA0qC2aVKFNcoRjG/fZZmQV5PiUvwKkdWFeTh2qmpssZPbqJwoRdpb1Ko084R5Lm+G5Z7tzpa2xo4ulo/CUPWwi9mrsWUaMVk9jh2ePDhveWxa3YLE1aDhhZRjOUkpNuz2H7TjLg87332vbOxrFWGG0HhrJKpWmu6VWS/2043/AO28655nne6XL6jFfdmjHFRjXS/E/wDSOgxkmrrNFThGgtfcVhcTKvUk61Oo/wCLRvZJbk6KeUGlw3PjzXbdFaSpYqlGvRmp05q6kvimt6knk09xVqNLkwVu6fkrjOMujKBUptq9rq/K6v5GYkCLrY+TfZdl3LMz8bPZhJ9LeeX1IOJOCvkE5hqu3FPwfeYOkaG1Vi3uUV4u7GBxChdPv8SkpuTuznKfBJRtlyJI4COTfP6EY52ROQVkkiposlLiioAOFYAAAAAAAAAAAAAAAAAAMfE4ZSzWT+feZAB1OiDrQcXZqxjzdifxFJSVrXIqvg77s+jJqRNckZisO5ptb4ra71x+5hYPEypSUo+K4NcmZsZyoSus1uafyZg1UrtxVle6XLoaMOZSeyXZDPp5RXqR5Xz/AFNjqVFLtJNXSdnvR7oYi1kyPwmK21Z+1x69UZFLOUV1XzKXFp8krTiSgKgiVlAVABQFQAUOf+kfVKVa+Mo3lJRSqU7t3jH81NdOMVv3rO9+ggtw5pYp7okZRUlTPmWvRJDVPWetoyrtw7dKTXraLeU170fdmlufg+nQPSFqXbaxeHjlnKrSS3c6kFy5rx5nL69E+ixZceox/k+0ZGnBnfaWsdGvh418PNSU8lzg17SnHhJXWXXkR9Oo1JSvne9+pxXQul6uCqeshnF+3TfszX0fJ/8AR1nQulaWKpqrSd1uaftQlxjJcGedl0no9cotU9xt2lKl6aa/M15WuRUSksRKUYxe6O79ysTEo7VRcmXoF2LLMC9ErkWo8vN/A2QgqcUmnyzJyDuk+hXklfRHa12VABWAAAAAAAAAAAAAAAAAAAAADGxuI2ErLNkTUxEnx8iaxNBTVn4PkRNfAzjwuua+xONEkzxgYKcmpZpxd/gR2MwjpycXu3p80Z2Gqermm00tz8STxeGVWNvGMuX7Ec0L5Rdp8/pyp9Ps1qhT7StzuSDkY8qcqcrNWa+J72yUMrnxLslmwKH80OmSWjq0pNpu+V8zPInR2IjFvayvxJZHZKmZQCoInCgKgAoCoAKHLfSDqX6vaxeHj/D31aa/u+c4r3Oa4d27qYaL8GeWGW6JGcVJUfMdeiNEaUq4Kr62k+k4P2akeT+j4eZ0T0gameoviaEf4LznBf3LfFfyfLu3c7r0T6PFlhmha5TMcouLOvaA0zSxlNVab6Sg/apy92S+vEloGoej/QTwtKVSatUqtNp74wjfZT69qT8VyNwps8bPGMZtR6NUHxyXYF2LM7COi90Unyf3Zdp4f1k9trsrJL3rce4xt/MtuimDwd7Slu3pc+8kQCls63YABw4AAAAAAAAAAAAAAAAAAAAAAAACzOh7rt04F4AEZiaTeUl3P7MwK+G2VdZo2ItyoRfA6quyxZGo7fBq7ZKYWpJQir8DOlgYPh8vsVWDjzfw+xZKaaIIxPXS5lY1JvddmbHDRXAupW3ENwMONKo+Nj2sPP3/AIGUDlnDFeHn/ifAtTpVVxv3W+png7uBESrTWTbR4eJn7z+BMTgnk1cx54CD5ruf3JKS8gjZ15NNN3TVmmk00+DRr+F1UwlObqRp9q90221D9MXkvmba9G/zfD9yi0Yve+BbHNt9roi432QTwrW53PVKhJuyi33GwQ0fBb7vvf2MmEEskku4i8wUSEwujptq62Vxvb5E6AVSk2SAAIgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//9k=');
            background-size: contain;
            background-position: center;
            background-attachment: fixed;
        }
        .result-item, .image-result-item { transition: all 0.3s ease; opacity: 0; transform: translateY(20px); }
        .result-item.visible, .image-result-item.visible { opacity: 1; transform: translateY(0); }
        .btn-custom { background-color: #1e73be; color: white; }
        .btn-custom:hover { background-color: #165a96; }
        .hidden { display: none; }
        .content-box { background-color: rgba(255, 255, 255, 0.95); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
        #imageResultsGrid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
        .image-result-item img { width: 100%; height: 150px; object-fit: cover; border-radius: 0.5rem; }
        #imagePreview { max-height: 100px; border-radius: 0.5rem; }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <header class="text-center mb-8 p-4 rounded-lg content-box shadow-lg">
            <h1 class="text-3xl md:text-4xl font-bold text-[#1e73be]">Wyszukiwarka i Ekstraktor Danych Źródłowych IB Search</h1>
            <p class="text-[#2687dd] mt-2">Wyszukuj strony, obrazy i dźwięki z zaawansowanymi filtrami.</p>
        </header>

        <div class="p-6 rounded-lg shadow-md mb-8 content-box">
            <div class="flex flex-col sm:flex-row gap-4">
                <input type="text" id="searchInput" placeholder="Wpisz frazę lub prześlij obraz..." class="flex-grow p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                <button id="searchButton" class="btn-custom font-bold py-3 px-6 rounded-md transition duration-300 shadow-sm flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                    Wyszukaj
                </button>
            </div>
            
            <!-- NOWA SEKCJA: Przesyłanie obrazu -->
            <div id="imageUploadSection" class="hidden mt-4 text-center">
                <p class="text-sm text-gray-600 mb-2">...lub wyszukaj na podstawie przesłanego obrazu:</p>
                <input type="file" id="imageUploader" accept="image/*" class="w-full max-w-xs mx-auto text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                <div id="imagePreviewContainer" class="mt-2 hidden"><img id="imagePreview" src="#" alt="Podgląd obrazu" /></div>
            </div>

            <div class="mt-4">
                <a href="#" id="toggleAdvanced" class="text-sm text-blue-800 hover:underline">Pokaż wyszukiwanie zaawansowane</a>
                <div id="advancedSearch" class="hidden mt-4 p-4 bg-gray-50/80 rounded-md border">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="searchType" class="block text-sm font-medium text-[#1e73be]">Typ wyszukiwania</label>
                            <select id="searchType" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                                <option value="all">Wszystko</option>
                                <option value="image">Obrazy</option>
                                <option value="sound">Dźwięki</option>
                            </select>
                        </div>
                        <div>
                            <label for="language" class="block text-sm font-medium text-[#1e73be]">Język wyników</label>
                            <select id="language" class="mt-1 w-full p-2 border border-gray-300 rounded-md"><option value="">Dowolny</option><option value="lang_pl">Polski</option><option value="lang_en">Angielski</option><option value="lang_de">Niemiecki</option></select>
                        </div>
                         <div>
                            <label for="fileTypeInput" class="block text-sm font-medium text-[#1e73be]">Szukaj plików typu (np. pdf)</label>
                            <input type="text" id="fileTypeInput" placeholder="pdf" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="siteSearchInput" class="block text-sm font-medium text-[#1e73be]">Szukaj w domenie (np. gov.pl)</label>
                            <input type="text" id="siteSearchInput" placeholder="example.com" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="excludeSiteInput" class="block text-sm font-medium text-[#1e73be]">Wyklucz domeny (np. wikipedia.org)</label>
                            <input type="text" id="excludeSiteInput" placeholder="wikipedia.org" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="excludeInput" class="block text-sm font-medium text-[#1e73be]">Wyklucz słowa (np. blog)</label>
                            <input type="text" id="excludeInput" placeholder="forum blog" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="resultsContainer" class="p-6 rounded-lg shadow-md min-h-[100px] content-box">
            <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-[#1e73be]">Wyniki</h2><button id="exportButton" class="btn-custom font-bold text-[#1e73be] py-2 px-4 rounded-md transition duration-300 shadow-sm disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Eksportuj do .txt</button></div>
            <div id="loader" class="text-center hidden py-8"><svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="mt-2 text-gray-500">Pobieranie danych...</p></div>
            <ul id="resultsList" class="space-y-4"></ul>
            <div id="imageResultsGrid"></div>
            <p id="initialMessage" class="text-center text-[#1e73be] py-8">Wyniki wyszukiwania pojawią się w tym miejscu.</p>
        </div>

        <footer class="text-center mt-8 text-sm text-white font-semibold p-2 rounded-lg" style="background-color: #1e73be"><p>&copy; 2025 - IBPanel</p></footer>
    </div>

    <script>
        const allElements = {
            searchInput: document.getElementById('searchInput'),
            searchButton: document.getElementById('searchButton'),
            resultsList: document.getElementById('resultsList'),
            imageResultsGrid: document.getElementById('imageResultsGrid'),
            loader: document.getElementById('loader'),
            initialMessage: document.getElementById('initialMessage'),
            exportButton: document.getElementById('exportButton'),
            toggleAdvanced: document.getElementById('toggleAdvanced'),
            advancedSearch: document.getElementById('advancedSearch'),
            siteSearchInput: document.getElementById('siteSearchInput'),
            fileTypeInput: document.getElementById('fileTypeInput'),
            excludeInput: document.getElementById('excludeInput'),
            excludeSiteInput: document.getElementById('excludeSiteInput'),
            searchType: document.getElementById('searchType'),
            language: document.getElementById('language'),
            imageUploadSection: document.getElementById('imageUploadSection'),
            imageUploader: document.getElementById('imageUploader'),
            imagePreview: document.getElementById('imagePreview'),
            imagePreviewContainer: document.getElementById('imagePreviewContainer'),
        };

        let currentResults = [];
        let uploadedImageBase64 = null;

        allElements.toggleAdvanced.addEventListener('click', (e) => {
            e.preventDefault();
            allElements.advancedSearch.classList.toggle('hidden');
            allElements.toggleAdvanced.textContent = allElements.advancedSearch.classList.contains('hidden') ? 'Pokaż wyszukiwanie zaawansowane' : 'Ukryj wyszukiwanie zaawansowane';
        });
        
        allElements.searchType.addEventListener('change', () => {
            if (allElements.searchType.value === 'image') {
                allElements.imageUploadSection.classList.remove('hidden');
            } else {
                allElements.imageUploadSection.classList.add('hidden');
            }
        });
        
        allElements.imageUploader.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadedImageBase64 = e.target.result.split(',')[1]; // Pobierz tylko część Base64
                    allElements.imagePreview.src = e.target.result;
                    allElements.imagePreviewContainer.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        allElements.searchButton.addEventListener('click', performSearch);
        allElements.searchInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') performSearch(); });
        allElements.exportButton.addEventListener('click', exportResults);

        async function performSearch() {
            const query = allElements.searchInput.value.trim();
            const imageFile = allElements.imageUploader.files[0];

            if (!query && !imageFile) {
                alert('Proszę wpisać frazę lub przesłać obraz.');
                return;
            }

            prepareUIForSearch();

            if (imageFile && allElements.searchType.value === 'image' && uploadedImageBase64) {
                await searchByImage();
            } else {
                await searchByText(query);
            }
            
            allElements.loader.classList.add('hidden');
        }
        
        function prepareUIForSearch() {
            allElements.initialMessage.classList.add('hidden');
            allElements.resultsList.innerHTML = '';
            allElements.imageResultsGrid.innerHTML = '';
            allElements.loader.classList.remove('hidden');
            allElements.exportButton.disabled = true;
            currentResults = [];
        }

        async function searchByImage() {
            try {
                const response = await fetch('/api/search-by-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: uploadedImageBase64 })
                });
                if (!response.ok) throw new Error(`Błąd serwera: ${response.statusText}`);
                const searchResults = await response.json();
                currentResults = searchResults.results || [];
                displayResults(currentResults, 'image');
            } catch (error) {
                handleSearchError(error);
            }
        }

        async function searchByText(query) {
            const params = new URLSearchParams({ q: query });
            if (allElements.siteSearchInput.value.trim()) params.append('siteSearch', allElements.siteSearchInput.value.trim());
            if (allElements.fileTypeInput.value.trim()) params.append('fileType', allElements.fileTypeInput.value.trim());
            if (allElements.excludeInput.value.trim()) params.append('exclude', allElements.excludeInput.value.trim());
            if (allElements.excludeSiteInput.value.trim()) params.append('excludeSite', allElements.excludeSiteInput.value.trim());
            if (allElements.searchType.value) params.append('searchType', allElements.searchType.value);
            if (allElements.language.value) params.append('lr', allElements.language.value);

            try {
                const response = await fetch(`/api/search?${params.toString()}`);
                if (!response.ok) throw new Error(`Błąd serwera: ${response.statusText}`);
                const searchResults = await response.json();
                currentResults = searchResults.results || [];
                displayResults(currentResults, allElements.searchType.value);
            } catch (error) {
                handleSearchError(error);
            }
        }
        
        function handleSearchError(error) {
            console.error("Błąd podczas wyszukiwania:", error);
            allElements.resultsList.innerHTML = `<li class="text-red-500 text-center">Wystąpił błąd: ${error.message}. Sprawdź konsolę serwera.</li>`;
        }

        function displayResults(results, type) {
            if (results.length === 0) {
                allElements.initialMessage.innerText = `Brak wyników dla podanych kryteriów.`;
                allElements.initialMessage.classList.remove('hidden');
                return;
            }
            allElements.exportButton.disabled = false;
            if (type === 'image') displayImageResults(results);
            else displayTextResults(results);
        }
        
        function displayTextResults(results) {
             results.forEach((item, index) => {
                const listItem = document.createElement('li');
                listItem.className = 'result-item border p-4 rounded-md bg-gray-50/90 hover:bg-gray-100/90 hover:shadow-sm';
                let dateString = 'Brak daty';
                if (item.publication_time) {
                    try { dateString = new Date(item.publication_time).toLocaleDateString('pl-PL', { year: 'numeric', month: 'long', day: 'numeric' }); } catch (e) { dateString = item.publication_time; }
                }
                listItem.innerHTML = `
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center">
                        <div class="flex-grow mb-2 sm:mb-0">
                            <h3 class="font-semibold text-[#1e73be]">${item.source_title || 'Brak tytułu'}</h3>
                            <p class="text-sm text-[#1e73be]">${item.snippet || 'Brak opisu.'}</p>
                        </div>
                        <div class="text-sm text-[#1e73be] sm:text-right flex-shrink-0 sm:ml-4"><p><strong>Data:</strong> ${dateString}</p></div>
                    </div>
                    <div class="mt-3"><a href="${item.url}" target="_blank" rel="noopener noreferrer" class="text-blue-800 text-sm hover:underline break-all">${item.url}</a></div>`;
                allElements.resultsList.appendChild(listItem);
                setTimeout(() => listItem.classList.add('visible'), index * 100);
            });
        }

        function displayImageResults(results) {
            results.forEach((item, index) => {
                const imageItem = document.createElement('div');
                imageItem.className = 'image-result-item group relative';
                imageItem.innerHTML = `
                    <a href="${item.contextUrl}" target="_blank" rel="noopener noreferrer">
                        <img src="${item.imageUrl}" alt="${item.source_title}" class="shadow-lg group-hover:opacity-75 transition-opacity">
                        <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <p class="text-[#1e73be] text-center text-sm p-2">${item.source_title}</p>
                        </div>
                    </a>`;
                allElements.imageResultsGrid.appendChild(imageItem);
                setTimeout(() => imageItem.classList.add('visible'), index * 100);
            });
        }

        function exportResults() {
            if (currentResults.length === 0) return;
            let textContent = `Wyniki wyszukiwania\nData eksportu: ${new Date().toLocaleString('pl-PL')}\n==================================================\n\n`;
            currentResults.forEach((item, index) => {
                textContent += `ŹRÓDŁO ${index + 1}\n`;
                textContent += `Tytuł: ${item.source_title || 'Brak'}\n`;
                const link = allElements.searchType.value === 'image' ? item.contextUrl : item.url;
                textContent += `Link: ${link || 'Brak'}\n`;
                if (allElements.searchType.value !== 'image') {
                    textContent += `Data publikacji: ${item.publication_time ? new Date(item.publication_time).toLocaleDateString('pl-PL') : 'Brak'}\n`;
                    textContent += `Fragment: ${item.snippet || 'Brak'}\n`;
                }
                textContent += "\n--------------------------------------------------\n\n";
            });
            const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `wyniki-${new Date().toISOString().slice(0,10)}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>

